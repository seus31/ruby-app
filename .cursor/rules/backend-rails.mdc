---
description: Ruby on Rails ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºãƒ«ãƒ¼ãƒ«ï¼ˆCursorç”¨ï¼‰
---

# Ruby on Rails é–‹ç™ºãƒ«ãƒ¼ãƒ«

## ğŸš¨ ç’°å¢ƒæ±šæŸ“ã®é˜²æ­¢ï¼ˆçµ¶å¯¾å³å®ˆï¼‰
**ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã§ `bundle install` ã‚„ Rails ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãªã„ã€‚**

ã™ã¹ã¦ã®ã‚³ãƒãƒ³ãƒ‰ã¯ Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã™ã‚‹ï¼š
```bash
docker compose run --rm backend bundle install
docker compose run --rm backend bundle exec rails db:migrate
docker compose run --rm backend bundle exec rails console
docker compose run --rm backend bundle exec rspec
```

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â””â”€â”€ api/v1/          # API v1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ models/              # ActiveRecordãƒ¢ãƒ‡ãƒ«
â”‚   â”œâ”€â”€ serializers/         # active_model_serializers
â”‚   â””â”€â”€ services/            # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ routes.rb
â”‚   â””â”€â”€ database.yml
â”œâ”€â”€ db/
â”‚   â””â”€â”€ migrate/
â””â”€â”€ spec/                    # RSpecãƒ†ã‚¹ãƒˆ
```

---

## ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«

### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
```ruby
class Api::V1::UsersController < ApplicationController
  before_action :authenticate_user!, only: [:update, :destroy]
  before_action :set_user, only: [:show, :update, :destroy]

  def index
    @users = User.all
    render json: @users, each_serializer: UserSerializer
  end

  def show
    render json: @user, serializer: UserSerializer
  end

  def create
    @user = User.new(user_params)
    
    if @user.save
      render json: @user, serializer: UserSerializer, status: :created
    else
      render json: { errors: @user.errors.full_messages }, status: :unprocessable_entity
    end
  end

  private

  def set_user
    @user = User.find(params[:id])
  end

  def user_params
    params.require(:user).permit(:name, :email, :password)
  end
end
```

### ãƒ¢ãƒ‡ãƒ«
```ruby
class User < ApplicationRecord
  has_secure_password

  validates :name, presence: true, length: { maximum: 100 }
  validates :email, presence: true, uniqueness: true, format: { with: URI::MailTo::EMAIL_REGEXP }
  validates :password, length: { minimum: 8 }, if: :password_digest_changed?

  # ã‚¹ã‚³ãƒ¼ãƒ—ã¯ä¸Šéƒ¨ã«é…ç½®
  scope :active, -> { where(active: true) }
  scope :recent, -> { order(created_at: :desc) }

  # ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰
  def self.find_by_email(email)
    find_by(email: email.downcase)
  end

  # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰
  def full_name
    "#{first_name} #{last_name}"
  end

  private

  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã¯æœ€ä¸‹éƒ¨
  def normalize_email
    self.email = email.downcase
  end
end
```

### Serializer
```ruby
class UserSerializer < ActiveModel::Serializer
  attributes :id, :name, :email, :created_at

  # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã®æ©Ÿå¯†æƒ…å ±ã¯çµ¶å¯¾ã«å«ã‚ãªã„
  def created_at
    object.created_at.iso8601
  end
end
```

### Service Object
```ruby
# app/services/user_authentication_service.rb
class UserAuthenticationService
  def initialize(email, password)
    @email = email
    @password = password
  end

  def call
    user = User.find_by_email(@email)
    return failure('Invalid email or password') unless user&.authenticate(@password)

    token = JWT.encode({ user_id: user.id }, Rails.application.credentials.secret_key_base)
    success(user, token)
  end

  private

  def success(user, token)
    { success: true, user: user, token: token }
  end

  def failure(message)
    { success: false, error: message }
  end
end
```

---

## ãƒ†ã‚¹ãƒˆï¼ˆRSpecï¼‰

### ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ
```ruby
# spec/models/user_spec.rb
require 'rails_helper'

RSpec.describe User, type: :model do
  describe 'validations' do
    it { should validate_presence_of(:name) }
    it { should validate_presence_of(:email) }
    it { should validate_uniqueness_of(:email) }
  end

  describe '#full_name' do
    it 'returns the full name' do
      user = User.new(first_name: 'John', last_name: 'Doe')
      expect(user.full_name).to eq('John Doe')
    end
  end
end
```

### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ†ã‚¹ãƒˆ
```ruby
# spec/requests/api/v1/users_spec.rb
require 'rails_helper'

RSpec.describe 'Api::V1::Users', type: :request do
  describe 'GET /api/v1/users' do
    it 'returns all users' do
      create_list(:user, 3)
      get '/api/v1/users'
      
      expect(response).to have_http_status(:ok)
      expect(JSON.parse(response.body).size).to eq(3)
    end
  end
end
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
```bash
docker compose run --rm backend bundle exec rails g migration CreateUsers name:string email:string
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```bash
docker compose run --rm backend bundle exec rails db:migrate
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
docker compose run --rm backend bundle exec rails db:rollback
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Strong Parametersï¼ˆå¿…é ˆï¼‰
```ruby
def user_params
  params.require(:user).permit(:name, :email, :password)
end
```

### CSRFå¯¾ç­–
- APIãƒ¢ãƒ¼ãƒ‰ã§ã¯ `protect_from_forgery` ã¯ä¸è¦
- JWTèªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹èªè¨¼

### ç’°å¢ƒå¤‰æ•°
```ruby
# config/database.yml
production:
  <<: *default
  database: <%= ENV['DATABASE_NAME'] %>
  username: <%= ENV['DATABASE_USER'] %>
  password: <%= ENV['DATABASE_PASSWORD'] %>
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### N+1ã‚¯ã‚¨ãƒªã®é˜²æ­¢
```ruby
# Bad
users = User.all
users.each { |user| puts user.posts.count }

# Good
users = User.includes(:posts)
users.each { |user| puts user.posts.count }
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ 
```ruby
class AddIndexToUsersEmail < ActiveRecord::Migration[7.1]
  def change
    add_index :users, :email, unique: true
  end
end
```

---

## ç¦æ­¢äº‹é …
- âŒ ãƒ›ã‚¹ãƒˆã§ã® `bundle install` å®Ÿè¡Œ
- âŒ Strong Parameters ã‚’ä½¿ã‚ãªã„å®Ÿè£…
- âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã®æ©Ÿå¯†æƒ…å ±ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
- âŒ N+1ã‚¯ã‚¨ãƒªã‚’æ”¾ç½®
- âŒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—ã® WHERE å¥
